<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Franz Canvas</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { width: 100%; height: 100%; background: #0a0a0f; overflow: hidden; }
canvas { display: block; width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
#status { position: absolute; bottom: 4px; left: 6px; font: 10px/1 Consolas,monospace; color: rgba(255,255,255,0.35); pointer-events: none; }
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="status">waiting</div>
<script>
"use strict";
(function () {

var canvas = document.getElementById("c");
var ctx = canvas.getContext("2d");
var status = document.getElementById("status");
var lastSeq = -1;

function poll() {
    var x = new XMLHttpRequest();
    x.open("GET", "/render_job", true);
    x.timeout = 1000;
    x.onload = function () {
        try {
            var d = JSON.parse(x.responseText);
            if (d && d.seq !== undefined && d.seq !== lastSeq) {
                lastSeq = d.seq;
                processJob(d);
            }
        } catch (e) {}
        setTimeout(poll, 200);
    };
    x.onerror = x.ontimeout = function () { setTimeout(poll, 800); };
    x.send();
}

function processJob(j) {
    var img = new Image();
    img.onload = function () {
        var w = img.naturalWidth;
        var h = img.naturalHeight;
        canvas.width = w;
        canvas.height = h;
        ctx.drawImage(img, 0, 0);

        var actions = j.actions || [];
        if (actions.length > 0) {
            drawHeat(actions, w, h);
            drawMarkers(actions, w, h);
        }

        canvas.toBlob(function (blob) {
            var reader = new FileReader();
            reader.onload = function () {
                submitAnnotated(j.seq, reader.result.split(",")[1]);
            };
            reader.readAsDataURL(blob);
        }, "image/png");

        status.textContent = "turn " + j.seq + " | " + actions.length + " act";
    };
    img.onerror = function () {
        status.textContent = "img error seq=" + j.seq;
        submitAnnotated(j.seq, "");
    };
    img.src = "data:image/png;base64," + j.image_b64;
}

function drawHeat(actions, w, h) {
    var heatCanvas = document.createElement("canvas");
    heatCanvas.width = w;
    heatCanvas.height = h;
    var hc = heatCanvas.getContext("2d");
    hc.globalCompositeOperation = "lighter";

    var baseR = Math.round(Math.min(w, h) * 0.22);

    for (var i = 0; i < actions.length; i++) {
        var a = actions[i];
        var name = a.name || "";
        var args = a.args || [];

        if ((name === "click" || name === "right_click" || name === "double_click") && args.length >= 2) {
            var px = args[0] * w / 1000;
            var py = args[1] * h / 1000;
            paintClickHeat(hc, px, py, baseR);

        } else if (name === "drag" && args.length >= 4) {
            var x0 = args[0] * w / 1000;
            var y0 = args[1] * h / 1000;
            var x1 = args[2] * w / 1000;
            var y1 = args[3] * h / 1000;
            paintDragHeat(hc, x0, y0, x1, y1, baseR);
        }
    }

    ctx.globalAlpha = 1.0;
    ctx.drawImage(heatCanvas, 0, 0);
}

function paintClickHeat(hc, px, py, r) {
    var g = hc.createRadialGradient(px, py, 0, px, py, r);
    g.addColorStop(0.0,  "rgba(255, 40,  0, 0.88)");
    g.addColorStop(0.25, "rgba(255, 80,  0, 0.70)");
    g.addColorStop(0.55, "rgba(255, 120, 0, 0.35)");
    g.addColorStop(1.0,  "rgba(255, 160, 0, 0.00)");
    hc.beginPath();
    hc.arc(px, py, r, 0, Math.PI * 2);
    hc.fillStyle = g;
    hc.fill();
}

function paintDragHeat(hc, x0, y0, x1, y1, r) {
    var dx = x1 - x0;
    var dy = y1 - y0;
    var len = Math.sqrt(dx * dx + dy * dy);

    paintClickHeat(hc, x0, y0, r);
    paintClickHeat(hc, x1, y1, r);

    if (len < 2) return;

    var steps = Math.max(2, Math.round(len / (r * 0.4)));
    for (var s = 1; s < steps; s++) {
        var t = s / steps;
        var mx = x0 + dx * t;
        var my = y0 + dy * t;
        var innerR = hc.createRadialGradient(mx, my, 0, mx, my, r * 0.75);
        innerR.addColorStop(0.0,  "rgba(255, 60,  0, 0.55)");
        innerR.addColorStop(0.5,  "rgba(255, 100, 0, 0.25)");
        innerR.addColorStop(1.0,  "rgba(255, 140, 0, 0.00)");
        hc.beginPath();
        hc.arc(mx, my, r * 0.75, 0, Math.PI * 2);
        hc.fillStyle = innerR;
        hc.fill();
    }
}

function drawMarkers(actions, w, h) {
    for (var i = 0; i < actions.length; i++) {
        var a = actions[i];
        var name = a.name || "";
        var args = a.args || [];
        if ((name === "click" || name === "right_click" || name === "double_click") && args.length >= 2) {
            drawClickMarker(args[0] * w / 1000, args[1] * h / 1000, name, i + 1);
        } else if (name === "drag" && args.length >= 4) {
            drawDragMarker(args[0] * w / 1000, args[1] * h / 1000, args[2] * w / 1000, args[3] * h / 1000, i + 1);
        }
    }
}

function drawClickMarker(px, py, name, idx) {
    ctx.strokeStyle = "rgba(255,255,255,0.9)";
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(px, py, 8, 0, Math.PI * 2); ctx.stroke();

    if (name === "double_click") {
        ctx.beginPath(); ctx.arc(px, py, 13, 0, Math.PI * 2);
        ctx.strokeStyle = "rgba(255,255,255,0.55)"; ctx.lineWidth = 1; ctx.stroke();
    }

    ctx.strokeStyle = "rgba(255,255,255,0.75)"; ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(px - 12, py); ctx.lineTo(px + 12, py);
    ctx.moveTo(px, py - 12); ctx.lineTo(px, py + 12);
    ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,0.95)";
    ctx.beginPath(); ctx.arc(px, py, 2, 0, Math.PI * 2); ctx.fill();

    if (name === "right_click") {
        ctx.font = "bold 8px Consolas,monospace";
        ctx.fillStyle = "rgba(255,255,255,0.9)";
        ctx.fillText("R", px + 11, py - 5);
    }

    ctx.font = "bold 8px Consolas,monospace";
    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillText(String(idx), px + 11, py + 5);
}

function drawDragMarker(x0, y0, x1, y1, idx) {
    ctx.strokeStyle = "rgba(255,255,255,0.8)"; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x1, y1); ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.beginPath(); ctx.arc(x0, y0, 3.5, 0, Math.PI * 2); ctx.fill();

    ctx.strokeStyle = "rgba(255,255,255,0.9)"; ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.arc(x1, y1, 5.5, 0, Math.PI * 2); ctx.stroke();

    var dx = x1 - x0, dy = y1 - y0, len = Math.sqrt(dx * dx + dy * dy);
    if (len > 5) {
        var nx = dx / len, ny = dy / len, al = Math.min(10, len * 0.25);
        ctx.strokeStyle = "rgba(255,255,255,0.9)"; ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.moveTo(x1, y1); ctx.lineTo(x1 - nx * al + ny * al * 0.5, y1 - ny * al - nx * al * 0.5);
        ctx.moveTo(x1, y1); ctx.lineTo(x1 - nx * al - ny * al * 0.5, y1 - ny * al + nx * al * 0.5);
        ctx.stroke();
    }

    ctx.font = "bold 8px Consolas,monospace"; ctx.fillStyle = "rgba(255,255,255,0.9)";
    ctx.fillText(String(idx), x0 + 6, y0 - 4);
}

function submitAnnotated(seq, b64) {
    var x = new XMLHttpRequest();
    x.open("POST", "/annotated", true);
    x.setRequestHeader("Content-Type", "application/json");
    x.send(JSON.stringify({ seq: seq, image_b64: b64 }));
}

poll();

})();
</script>
</body>
</html>
